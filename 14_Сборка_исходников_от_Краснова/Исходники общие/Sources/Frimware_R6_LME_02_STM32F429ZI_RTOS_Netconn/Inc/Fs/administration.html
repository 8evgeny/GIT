<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=windows-1251'>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<title>Администрирование</title>
</head>
<script src="/mchp.js" type="text/javascript"></script>
<body onLoad="loadCredentials()">

<script language="javascript">
if (readCookie("sid") == '') window.location = 'login.html';
</script>

<a href="\">
<img src="logo.png"  width="185" height="45">
</a>
<h3>Администрирование</h3>
<p><a href="/login.html" onClick="logOff()">Выход</a><a>&nbsp;&nbsp;&nbsp;</a><a href="mainpage.html">На главную</a></p>

<script language="JavaScript">

function saveRespHandler(xmlData) {
// Check if a timeout occurred
	if(!xmlData)
	{
		alert("Ошибка! Устройство LME не отвечает.\nПроверьте подключение.");
		return;
	} else {
		if (getXMLValue(xmlData, 'result') == "OK") {
			document.getElementById('result').innerHTML = "Успешно записано!";
			setTimeout("hideResult(); logOff();window.location.href = '/login.html';", 3000);
		} else if (getXMLValue(xmlData, 'result') == "ERR") {
			alert("Неверный логин или пароль!");
		} else {
			alert("Неверный формат XML!");
		}
	}
}
function resetToDefaultsHandler(xmlData) {
// Check if a timeout occurred
	if(!xmlData)
	{
		alert("Ошибка! Устройство LME не отвечает.\nПроверьте подключение.");
		return;
	} else {
		if (getXMLValue(xmlData, 'result') == "OK") {
			document.getElementById('result').innerHTML = "Успешно записано!";
			setTimeout("hideResult()", 3000);
		} else if (getXMLValue(xmlData, 'result') == "ERR") {
			alert("Сброс в заводские настройки завершился неудачей!");
		} else {
			alert("Неверный формат XML!");
		}
	}
}
function butSaveOnClick() {
	const cyrillicPattern = /^[\u0400-\u04FF]+$/;
	str = "save_credentials\n";
		
	if ((cyrillicPattern.test(document.getElementById('new_login').value))||
	(cyrillicPattern.test(document.getElementById('new_pass').value))) {
		alert("Кириллические символы не допускаются!");
		return;
	}

	addToStrNameAndValue("login");
	addToStrNameAndValue("pass");
	addToStrNameAndValue("new_login");
	addToStrNameAndValue("new_pass");
	
	newAJAXCommand('save_credentials.xml', saveRespHandler, false, str);
}
function butResetToDefaultsOnClick() {
	if (confirm("Вы уверены, что хотите произвести полный сброс настроек?")) {
		newAJAXCommand('reset_to_defaults.xml', resetToDefaultsHandler, false);
	}
}
function loadCredentials() {
	verbose = false;
	newAJAXCommand('credentials.xml', loadCredentialsHandler, false);
}
function parseCredentialsXML(xmlData) {
	document.getElementById('login').value = getXMLValue(xmlData, 'login');
	document.getElementById('pass').value = getXMLValue(xmlData, 'pass');
	document.getElementById('firm_ver').innerHTML = getXMLValue(xmlData, 'firm_ver');
}
function loadCredentialsHandler(xmlData) {
// Check if a timeout occurred
	if(!xmlData)
	{
		alert("Ошибка! Устройство LME не отвечает.\nПроверьте подключение.");
		return;
	} else {		
		parseCredentialsXML(xmlData); // заполняем все поля страницы данными из XML
		
		if (verbose == true) {
			document.getElementById('result').innerHTML = "Успешно прочитано!";
			setTimeout("hideResult()", 3000);		
		}
	}
}
</script>

<form method="post">

	<TABLE>
	<TR>
   	<TD>Версия прошивки</TD>
	<TD><span id="firm_ver"> </span></TD>
	</TR>
    <TR>
	<TD>Логин</TD>
	<TD>
		<input type="text" name="login" id="login" size="30" value="">
	</TD>
	</TR>
	<TR>
	<TD>Пароль</TD>
	<TD>
		<input type="password" name="pass" id="pass" size="30" value="">
	</TD>
	</TR>
    <TR>
	<TD>Новый логин</TD>
	<TD>
		<input type="text" name="new_login" id="new_login" size="30" value="">
	</TD>
	</TR>
	<TR>
	<TD>Новый пароль</TD>
	<TD>
		<input type="password" name="new_pass" id="new_pass" size="30" value="">
	</TD>
	</TR>
	
	<TD><br/></TD>
	<TR>
	<TD>          
        <input type="button" name="butSaveToDevice" id="butSaveToDevice" value="Сохранить" onClick="butSaveOnClick()" style="width:220px">
    </TD>
    <TD>          
        <input type="button" name="butResetToDefaults" id="butResetToDefaults" value="Сброс в заводские настройки" onClick="butResetToDefaultsOnClick()" style="width:220px">
    </TD>
	</TR>
	</TABLE>
	<p><i>Внимание! Кириллица в логине и пароле не допускается!</i></p>
</form>

<a href="/R6LME02.log" download="">Загрузить log-файл</a>

<div id="result">&nbsp;</div>

<!--<button onclick="foo()">btoa</button>
<script>
 
  function foo() {
    var string = "admin:admin";
 
    var btoaded = btoa(encodeURIComponent(string));
 
    console.log(btoaded);
 
    var atobed = decodeURIComponent(atob(btoaded));
 
    console.log(atobed);
	
 
    //var body = new FormData()
 
    //body.append('btoa', btoaded)
 
   // fetch('/decode.php', { method: 'POST', body }).then(r => r.text()).then(r => alert(r))
  }
</script>-->

</body>
</html>
